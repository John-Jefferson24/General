pyOpenSSL>=21.0.0

FROM registry-eng.sdi.corp.bankofamerica.com/bac/httpd-24-rhel9:latest

USER root

# Install dependencies for cryptography compilation
RUN dnf groupinstall -y "Development Tools" && \
    dnf install -y \
        python3 \
        python3-pip \
        python3-devel \
        openssl-devel \
        libffi-devel \
        rust \
        cargo && \
    dnf clean all

# Install mod_wsgi
RUN dnf install -y mod_wsgi && \
    dnf clean all

# Install mod_auth_openidc
RUN dnf install -y mod_auth_openidc && \
    dnf clean all

# Make directories
RUN mkdir -p /var/www/wsgi

# Copy application files
COPY ./app/sso.py /var/www/wsgi/sso.py
COPY ./app/router.py /var/www/wsgi/router.py
COPY ./app/router_v2.py /var/www/wsgi/router_v2.py
COPY ./app/auth.py /var/www/wsgi/auth.py
COPY ./app/ges.py /var/www/wsgi/ges.py
COPY ./app/requirements.txt /tmp/requirements.txt

# Set pip config for internal repo
COPY ./configs/pip.conf /etc/pip.conf

# Upgrade pip and install Python dependencies
RUN pip3 install --upgrade pip setuptools wheel && \
    pip3 install --no-cache-dir -r /tmp/requirements.txt

# Set environment variables
ENV PYTHONHOME=/usr
ENV PYTHONPATH=/usr/lib/python3.9:/usr/lib/python3.9/lib-dynload:/usr/lib/python3.9/site-packages

# Copy Apache configurations (uncommented these lines)
COPY ./configs/httpd.conf /etc/httpd/conf.d/httpd.conf

# Change permissions
RUN chmod -R 775 /etc/httpd/conf.d && \
    chmod -R 775 /etc/httpd/conf.modules.d && \
    chmod -R 775 /etc/httpd/conf && \
    chmod -R 775 /etc/httpd/logs && \
    chmod -R 775 /etc/httpd/run && \
    chmod -R 775 /etc/httpd/modules && \
    chmod -R 777 /run/httpd && \
    chmod -R 777 /var/log && \
    chmod -R 777 /var/www/html && \
    chmod -R 777 /var/www/wsgi

# Expose port
EXPOSE 8080
