#*****************************************************************
# Neo4j 5.26 Configuration for OpenShift with Edge Termination
#*****************************************************************

# Database settings
server.databases.default_to_read_only=false
initial.dbms.default_database=neo4j

# Memory settings (adjust based on your container limits)
server.memory.heap.initial_size=512m
server.memory.heap.max_size=2G
server.memory.pagecache.size=512m

# HTTP Connector (UI) - Plain HTTP since edge handles TLS
server.http.enabled=true
server.http.listen_address=0.0.0.0:7474
server.https.enabled=false

# Bolt Connector - Listen only on localhost since socat proxies
server.bolt.enabled=true
server.bolt.listen_address=127.0.0.1:7687

# Disable SSL policies since edge termination handles TLS
dbms.ssl.policy.bolt.enabled=false
dbms.ssl.policy.https.enabled=false

# Network settings
server.default_listen_address=0.0.0.0
server.default_advertised_address=localhost

# Security - Set to false for initial setup, enable after setting password
dbms.security.auth_enabled=false

# Transaction settings
db.transaction.timeout=30s
db.lock.acquisition.timeout=10s

# Directories (using default structure)
server.directories.data=data
server.directories.logs=logs
server.directories.import=import
server.directories.plugins=plugins

# Allow upgrade if needed
dbms.allow_upgrade=true

# Logging
server.logs.user.enabled=true

echo "Starting Neo4j with socat proxy for Bolt..."

# Start socat in background
# Listen on 8687, forward to Neo4j Bolt on 7687
echo "Starting socat proxy (8687 -> 7687)..."
socat TCP-LISTEN:8687,reuseaddr,fork,keepalive,nodelay TCP:127.0.0.1:7687 &
SOCAT_PID=$!

# Give socat a moment to start
sleep 2

# Check if socat is running
if ! kill -0 $SOCAT_PID 2>/dev/null; then
    echo "ERROR: socat failed to start"
    exit 1
fi

echo "socat proxy started with PID $SOCAT_PID"
