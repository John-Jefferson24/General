#!/usr/bin/env python3
import json
import sys

def application(environ, start_response):
    method = environ.get('REQUEST_METHOD', 'GET')

    if method == 'POST':
        try:
            # Read and parse request body
            content_length = int(environ.get('CONTENT_LENGTH', 0))
            body = environ['wsgi.input'].read(content_length)
            data = json.loads(body)

            # Extract the model name
            model_name = data.get('model')
            if not model_name:
                raise ValueError("Missing 'model' in request")

            # Redirect to the model-specific endpoint
            redirect_url = f'/model/{model_name}/v2'
            start_response('307 Temporary Redirect', [
                ('Location', redirect_url),
                ('Content-Type', 'text/plain'),
            ])
            return [b'Redirecting to model endpoint']

        except Exception:
            # Return 400 on parse/fallback error instead of looping
            start_response('400 Bad Request', [
                ('Content-Type', 'text/plain'),
            ])
            return [b'Invalid request: missing or bad JSON with model field']

    # Reject non-POST requests explicitly
    start_response('405 Method Not Allowed', [
        ('Content-Type', 'text/plain'),
    ])
    return [b'Only POST requests are allowed']
